rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Devices collection - users can only read/write their own device data
    match /devices/{deviceId} {
      // Allow read/write only if the deviceId matches the authenticated user's device ID
      // Since we're using device IDs (not Firebase Auth), we'll allow public read/write
      // but restrict based on deviceId matching
      // In production, you should add additional security checks
      
      allow read: if request.auth != null || resource.data.deviceId == deviceId;
      allow write: if request.auth != null || request.resource.data.deviceId == deviceId;
      
      // Family members subcollection
      match /familyMembers/{memberId} {
        // Allow read/write only for the device owner
        allow read: if request.auth != null || true; // Allow for offline mesh communication
        allow write: if request.auth != null || request.resource.data.deviceId == deviceId;
        allow delete: if request.auth != null || true;
      }
      
      // Health profile subcollection
      match /healthProfile/{profileId} {
        allow read: if request.auth != null || true; // Allow for emergency access
        allow write: if request.auth != null || request.resource.data.deviceId == deviceId;
        allow delete: if request.auth != null || request.resource.data.deviceId == deviceId;
      }
      
      // ICE (In Case of Emergency) subcollection
      match /ice/{iceId} {
        allow read: if request.auth != null || true; // Allow for emergency access
        allow write: if request.auth != null || request.resource.data.deviceId == deviceId;
        allow delete: if request.auth != null || request.resource.data.deviceId == deviceId;
      }
      
      // Location updates subcollection
      match /locationUpdates/{locationId} {
        allow read: if request.auth != null || true; // Allow for family member tracking
        allow write: if request.auth != null || request.resource.data.deviceId == deviceId;
        allow delete: if request.auth != null || request.resource.data.deviceId == deviceId;
      }
      
      // Status updates subcollection
      match /statusUpdates/{statusId} {
        allow read: if request.auth != null || true; // Allow for family member tracking
        allow write: if request.auth != null || request.resource.data.deviceId == deviceId;
        allow delete: if request.auth != null || request.resource.data.deviceId == deviceId;
      }
      
      // Earthquake alerts subcollection
      match /earthquakeAlerts/{alertId} {
        allow read: if request.auth != null || resource.data.deviceId == deviceId;
        allow write: if request.auth != null || request.resource.data.deviceId == deviceId;
        allow delete: if request.auth != null || request.resource.data.deviceId == deviceId;
      }
    }
    
    // Emergency SOS signals collection
    match /sos/{sosId} {
      // Allow anyone to read SOS signals (for emergency response)
      // But only allow write with proper authentication or device ID validation
      allow read: if true;
      allow write: if request.auth != null || request.resource.data.deviceId != null;
      allow delete: if request.auth != null || request.resource.data.deviceId == resource.data.deviceId;
    }
    
    // Messages collection (for BLE mesh backup)
    match /messages/{messageId} {
      // Allow read/write for authenticated users or device ID matching
      allow read: if request.auth != null || resource.data.from == deviceId || resource.data.to == deviceId;
      allow write: if request.auth != null || request.resource.data.from == deviceId;
      allow delete: if request.auth != null || request.resource.data.from == deviceId || request.resource.data.to == deviceId;
    }
    
    // Earthquakes collection (public read for emergency awareness)
    match /earthquakes/{earthquakeId} {
      allow read: if true; // Public read for emergency awareness
      allow write: if request.auth != null || request.resource.data.magnitude >= 4.0; // Only allow critical earthquakes
      allow delete: if request.auth != null; // Only authenticated users can delete
    }
    
    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

