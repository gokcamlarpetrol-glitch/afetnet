rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================
    // HELPER FUNCTIONS
    // ============================================================
    
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() && request.auth.token.admin == true;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isDeviceOwner(deviceId) {
      return isAuthenticated()
             && exists(/databases/$(database)/documents/devices/$(deviceId))
             && get(/databases/$(database)/documents/devices/$(deviceId)).data.ownerUid == request.auth.uid;
    }

    function requesterQrId() {
      return isAuthenticated()
             && exists(/databases/$(database)/documents/users/$(request.auth.uid))
             ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.qrId
             : null;
    }

    function isLinkedFamilyMember(deviceId) {
      let qrId = requesterQrId();
      return isAuthenticated()
             && (
               exists(/databases/$(database)/documents/devices/$(deviceId)/familyMembers/$(request.auth.uid))
               || (
                 qrId is string
                 && exists(/databases/$(database)/documents/devices/$(deviceId)/familyMembers/$(qrId))
               )
             );
    }

    function isDeviceReadable(deviceId) {
      return isDeviceOwner(deviceId) || isLinkedFamilyMember(deviceId);
    }

    function isSenderOwned(senderDeviceId) {
      return isAuthenticated()
             && exists(/databases/$(database)/documents/devices/$(senderDeviceId))
             && get(/databases/$(database)/documents/devices/$(senderDeviceId)).data.ownerUid == request.auth.uid;
    }

    function isPendingRequestStatus(status) {
      return status == 'pending';
    }

    function isTerminalRequestStatus(status) {
      return status == 'accepted' || status == 'declined' || status == 'expired';
    }

    function isNewsSummaryJobOwner(articleId) {
      return isAuthenticated()
             && exists(/databases/$(database)/documents/news_summary_jobs/$(articleId))
             && get(/databases/$(database)/documents/news_summary_jobs/$(articleId)).data.ownerUid == request.auth.uid
             && get(/databases/$(database)/documents/news_summary_jobs/$(articleId)).data.status == 'processing'
             && get(/databases/$(database)/documents/news_summary_jobs/$(articleId)).data.leaseUntil is number
             && get(/databases/$(database)/documents/news_summary_jobs/$(articleId)).data.leaseUntil >= request.time.toMillis() - 1000;
    }
    
    function hasAppCheck() {
      return request.app != null;
    }
    
    // Rate limiting helper (approximate - check timestamp)
    function isNotSpamming() {
      return request.time > resource.data.createdAt + duration.value(1, 's');
    }
    
    // ============================================================
    // EEW COLLECTIONS - Elite Security
    // ============================================================
    
    // P-wave crowdsourced detections
    // - Anyone can write (for crowdsourcing)
    // - Rate limited (1 per second per device)
    // - Auto-expires after 5 minutes
    match /eew_pwave_detections/{detectionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated()
                    && request.resource.data.deviceId is string
                    && request.resource.data.timestamp is number
                    && request.resource.data.latitude is number
                    && request.resource.data.longitude is number
                    && request.resource.data.confidence is number
                    && request.resource.data.confidence >= 0
                    && request.resource.data.confidence <= 100;
      allow update: if false; // No updates allowed
      allow delete: if false; // Cleanup via Cloud Functions
    }
    
    // EEW broadcasts (official or crowdsourced)
    // - Public read
    // - Only authenticated users can create
    // - Only creator or admin can update/delete
    match /eew_broadcasts/{broadcastId} {
      allow read: if true;
      allow create: if isAuthenticated()
                    && request.resource.data.magnitude is number
                    && request.resource.data.latitude is number
                    && request.resource.data.longitude is number
                    && request.resource.data.source is string;
      allow update: if isAuthenticated()
                    && (resource.data.source == 'CROWDSOURCED' || isAdmin());
      allow delete: if isAdmin();
    }
    
    // EEW history (user-specific)
    // - Only owner can read/write
    match /eew_history/{entryId} {
      allow read: if isOwner(resource.data.userId);
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.timestamp is number;
      allow update: if isOwner(resource.data.userId);
      allow delete: if isOwner(resource.data.userId);
    }
    
    // P-wave consensus (aggregated data)
    // - Public read
    // - Only authenticated users can create/update
    match /eew_consensus/{consensusId} {
      allow read: if true;
      allow create: if isAuthenticated()
                    && request.resource.data.detectionCount is number
                    && request.resource.data.centerLatitude is number
                    && request.resource.data.centerLongitude is number;
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // EEW analytics (write-only for tracking)
    // - Anyone authenticated can write
    // - No reads (only Cloud Functions)
    match /eew_analytics/{eventId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated()
                    && request.resource.data.eventType is string
                    && request.resource.data.timestamp is number;
      allow update: if false;
      allow delete: if false;
    }
    
    // ============================================================
    // DEVICES COLLECTION - ELITE FAMILY TRACKING
    // ============================================================
    
    // Device documents store user's device info and current location
    // - Owner can read/write their own device
    // - Family members can read device location for tracking (via deviceId field match)
    // CRITICAL: Restrict to device owner via qrId matching
    match /devices/{deviceId} {
      // ELITE SECURITY: Owner or explicitly linked family member only
      allow read: if isDeviceReadable(deviceId);

      // First write must bind ownerUid to authenticated user
      allow create: if isAuthenticated()
                    && request.resource.data.ownerUid == request.auth.uid;

      // Owner-only updates; ownerUid cannot be changed after creation
      allow update: if (
                      isDeviceOwner(deviceId)
                      && request.resource.data.ownerUid == resource.data.ownerUid
                    ) || (
                      // Migration-safe claim: allow owner binding for legacy docs missing ownerUid
                      isAuthenticated()
                      && !(resource.data.ownerUid is string)
                      && request.resource.data.ownerUid == request.auth.uid
                    );
      allow delete: if false; // Devices should not be deleted
      
      // Family members subcollection
      // - Each device can have its own family members list
      match /familyMembers/{memberId} {
        allow read: if isDeviceReadable(deviceId);
        allow create: if isDeviceOwner(deviceId)
                      && request.resource.data.name is string
                      && request.resource.data.id is string;
        allow update: if isDeviceOwner(deviceId);
        allow delete: if isDeviceOwner(deviceId);
      }
      
      // Location history subcollection
      match /locations/{locationId} {
        allow read: if isDeviceReadable(deviceId);
        allow create: if isDeviceOwner(deviceId)
                      && request.resource.data.latitude is number
                      && request.resource.data.longitude is number;
        allow update: if isDeviceOwner(deviceId)
                      && request.resource.data.latitude is number
                      && request.resource.data.longitude is number;
        allow delete: if false; // Cleanup via Cloud Functions/TTL
      }
      
      // Status updates subcollection
      match /status/{statusId} {
        allow read: if isDeviceReadable(deviceId);
        allow create: if isDeviceOwner(deviceId);
        allow update: if isDeviceOwner(deviceId);
        allow delete: if false;
      }
      
      // Health profile subcollection
      match /health/{healthId} {
        allow read: if isDeviceOwner(deviceId);
        allow create: if isDeviceOwner(deviceId);
        allow update: if isDeviceOwner(deviceId);
        allow delete: if false;
      }
      
      // ICE (In Case of Emergency) data subcollection
      match /ice/{iceId} {
        allow read: if isDeviceOwner(deviceId);
        allow create: if isDeviceOwner(deviceId);
        allow update: if isDeviceOwner(deviceId);
        allow delete: if false;
      }
      
      // Messages subcollection  
      match /messages/{messageId} {
        allow read: if isDeviceOwner(deviceId);
        allow create: if isAuthenticated()
                      && exists(/databases/$(database)/documents/devices/$(deviceId))
                      && request.resource.data.fromDeviceId is string
                      && request.resource.data.toDeviceId is string
                      && isSenderOwned(request.resource.data.fromDeviceId)
                      && (isDeviceOwner(deviceId) || request.resource.data.toDeviceId == deviceId);
        allow update: if false;
        allow delete: if false;
      }
      
      // Conversations subcollection
      match /conversations/{conversationId} {
        allow read: if isDeviceOwner(deviceId);
        allow create: if isDeviceOwner(deviceId);
        allow update: if isDeviceOwner(deviceId);
        allow delete: if isDeviceOwner(deviceId);
      }
    }
    
    // ============================================================
    // SEISMIC DETECTIONS - Crowdsourced Data
    // ============================================================
    
    match /seismicDetections/{detectionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated()
                    && request.resource.data.deviceId is string
                    && request.resource.data.latitude is number
                    && request.resource.data.longitude is number;
      allow update: if false;
      allow delete: if false;
    }
    
    // ============================================================
    // NEW: FCM TOKEN MANAGEMENT
    // ============================================================
    
    // FCM tokens (user-specific)
    // - Only owner can read/write their token
    // - Token registration is required for push notifications
    match /fcm_tokens/{userId} {
      allow read: if isOwner(userId);
      allow create, update: if isOwner(userId)
                            && request.resource.data.token is string
                            && request.resource.data.platform is string;
      allow delete: if isOwner(userId);
      
      // FIX #7: Multi-device FCM token subcollection
      match /devices/{deviceId} {
        allow read: if isOwner(userId);
        allow create, update: if isOwner(userId)
                              && request.resource.data.token is string
                              && request.resource.data.platform is string;
        allow delete: if isOwner(userId);
      }
    }
    
    // ============================================================
    // NEW: PLUM OBSERVATIONS (Elite EEW)
    // ============================================================
    
    // PLUM intensity observations for proximity-based EEW
    // - Public read for P2P sharing
    // - Authenticated create
    match /plum_observations/{observationId} {
      allow read: if true;
      allow create: if isAuthenticated()
                    && request.resource.data.deviceId is string
                    && request.resource.data.latitude is number
                    && request.resource.data.longitude is number
                    && request.resource.data.intensity is number
                    && request.resource.data.timestamp is number;
      allow update: if false;
      allow delete: if false; // Cleanup via TTL or Cloud Functions
    }
    
    // ============================================================
    // NEW: EEW EVENTS (Server-Side Generated)
    // ============================================================
    
    // EEW events from official sources (AFAD, Kandilli, etc.)
    // - Public read
    // - Only Cloud Functions can write (via admin SDK)
    match /eew_events/{eventId} {
      allow read: if true;
      allow write: if false; // Only via Cloud Functions with admin SDK
    }
    
    // ============================================================
    // NEW: DAILY ANALYTICS (Aggregated)
    // ============================================================
    
    // Daily analytics summaries
    // - Admin only read
    // - Only Cloud Functions can write
    match /eew_analytics_daily/{docId} {
      allow read: if isAdmin();
      allow write: if false; // Only via Cloud Functions
    }
    
    // ============================================================
    // NEWS SUMMARIES - SHARED CACHE (Cost Optimization)
    // ============================================================
    
    // News summaries (shared across ALL users for cost optimization)
    // - Public read: All users can read cached summaries
    // - Write: only active summary job owner can create/update
    // - Summaries are shared by articleId, not userId
    // - This reduces OpenAI API costs significantly
    match /news_summaries/{summaryId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated()
                    && request.resource.data.articleId is string
                    && request.resource.data.summary is string
                    && request.resource.data.title is string
                    && request.resource.data.articleId == summaryId
                    && request.resource.data.createdBy == request.auth.uid
                    && isNewsSummaryJobOwner(summaryId);
      allow update: if isAuthenticated()
                    && request.resource.data.articleId is string
                    && request.resource.data.summary is string
                    && request.resource.data.articleId == summaryId
                    && request.resource.data.createdBy == request.auth.uid
                    && (
                      !(resource.data.createdBy is string)
                      || resource.data.createdBy == request.auth.uid
                    )
                    && isNewsSummaryJobOwner(summaryId);
      allow delete: if false; // Cleanup via Cloud Functions/TTL
    }

    // Summary generation leases (single-writer lock per article)
    match /news_summary_jobs/{summaryId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated()
                    && request.resource.data.articleId is string
                    && request.resource.data.articleId == summaryId
                    && request.resource.data.ownerUid == request.auth.uid
                    && request.resource.data.status == 'processing'
                    && request.resource.data.leaseUntil is number;
      allow update: if isAuthenticated()
                    && request.resource.data.articleId is string
                    && request.resource.data.articleId == summaryId
                    && request.resource.data.ownerUid == request.auth.uid
                    && request.resource.data.status is string
                    && (
                      // Current lock owner can update lifecycle state.
                      resource.data.ownerUid == request.auth.uid
                      // Expired lock can be taken over by another authenticated user.
                      || (
                        resource.data.leaseUntil is number
                        && resource.data.leaseUntil < request.time.toMillis()
                      )
                    );
      allow delete: if false;
    }
    
    // ============================================================
    // EXISTING COLLECTIONS (if not already defined)
    // ============================================================
    
    // Users collection
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if false;

      // Private contacts for each authenticated user
      match /contacts/{contactId} {
        allow read, create, update, delete: if isOwner(userId);
      }

      // Private block list for each authenticated user
      match /blocked/{blockedId} {
        allow read, create, update, delete: if isOwner(userId);
      }

      // Private reactions mirror for each authenticated user
      match /reactions/{reactionId} {
        allow read, create, update, delete: if isOwner(userId);
      }

      // Contact requests inbox.
      // Sender can create a pending request in recipient inbox; recipient can read/update/delete.
      match /contactRequests/{requestId} {
        allow read: if isOwner(userId);
        allow create: if isAuthenticated()
                      && request.auth.uid == requestId
                      && request.resource.data.fromUserId == request.auth.uid
                      && request.resource.data.toUserId == userId
                      && request.resource.data.status is string
                      && isPendingRequestStatus(request.resource.data.status)
                      && request.resource.data.fromQrId is string
                      && request.resource.data.fromName is string;
        allow update: if (
                        isOwner(userId)
                        && resource.data.fromUserId is string
                        && request.resource.data.fromUserId == resource.data.fromUserId
                        && request.resource.data.status is string
                        && isTerminalRequestStatus(request.resource.data.status)
                      ) || (
                        isAuthenticated()
                        && request.auth.uid == requestId
                        && request.resource.data.fromUserId == request.auth.uid
                        && request.resource.data.toUserId == userId
                        && request.resource.data.status is string
                        && isPendingRequestStatus(request.resource.data.status)
                      );
        allow delete: if isOwner(userId);
      }

      // Per-user notifications inbox.
      // Owner can manage; authenticated users can create notifications addressed to owner.
      match /notifications/{notificationId} {
        allow read, update, delete: if isOwner(userId);
        allow create: if isAuthenticated()
                      && request.resource.data.type is string
                      && request.resource.data.fromUserId is string
                      && request.resource.data.fromUserId == request.auth.uid;
      }
    }
    
    // Earthquakes collection (read-only for users, write via Cloud Functions)
    match /earthquakes/{earthquakeId} {
      allow read: if true;
      // ELITE SECURITY: Users cannot write earthquakes - only Cloud Functions with admin SDK
      allow write: if false;
    }
    
    // Felt earthquakes reports
    match /feltEarthquakes/{reportId} {
      allow read: if true;
      allow create: if isAuthenticated()
                    && request.resource.data.earthquakeId is string
                    && request.resource.data.userId is string
                    && request.resource.data.timestamp is number;
      allow update: if false;
      allow delete: if false;
    }
    
    // Family members (top-level collection)
    // ELITE SECURITY: Restrict to users who own the linked device
    match /familyMembers/{memberId} {
      allow read: if isAuthenticated() 
                  && (resource.data.ownerUid == request.auth.uid);
      allow create: if isAuthenticated() 
                    && request.resource.data.ownerUid == request.auth.uid;
      allow update: if isAuthenticated() 
                    && resource.data.ownerUid == request.auth.uid;
      allow delete: if isAuthenticated() 
                    && resource.data.ownerUid == request.auth.uid;
    }
    
    // SOS alerts
    match /sosAlerts/{alertId} {
      allow read: if isAuthenticated() || isAdmin();
      allow create: if isAuthenticated();
      allow update: if false;
      allow delete: if false;
    }
    
    // Messages
    match /messages/{messageId} {
      allow read: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
    
    // Catch-all deny for undefined paths
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
