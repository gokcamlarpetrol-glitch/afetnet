rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ============================================================
    // AFETNET ELITE FIRESTORE SECURITY RULES
    // Version: 2.0.0 - Enhanced with Contact Requests
    // ============================================================

    // Helper: Check if authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper: Check if user owns this resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ==================== USER PROFILES ====================
    match /users/{userId} {
      // Anyone authenticated can read basic profile (for QR contact lookup)
      allow read: if isAuthenticated();
      
      // Only owner can write their own profile
      allow write: if isOwner(userId);
      
      // ==================== CONTACTS ====================
      match /contacts/{contactId} {
        // Only owner can read/write contacts
        allow read, write: if isOwner(userId);
      }
      
      // ==================== BLOCKED USERS ====================
      match /blocked/{blockedId} {
        // Only owner can manage blocked list
        allow read, write: if isOwner(userId);
      }
      
      // ==================== CONTACT REQUESTS ====================
      match /contactRequests/{requestId} {
        // Owner can read their incoming requests
        allow read: if isOwner(userId);
        
        // Owner can update/delete (accept/decline) their requests
        allow update, delete: if isOwner(userId);
        
        // Anyone authenticated can create a request TO this user
        // (when they add this user as a contact)
        allow create: if isAuthenticated() 
          && request.resource.data.fromUserId == request.auth.uid
          && request.resource.data.status == 'pending';
      }
      
      // ==================== NOTIFICATIONS ====================
      match /notifications/{notificationId} {
        // Owner can read/delete their notifications
        allow read, delete: if isOwner(userId);
        
        // Anyone authenticated can create notifications
        allow create: if isAuthenticated();
        
        // Owner can update (mark as read)
        allow update: if isOwner(userId);
      }
      
      // ==================== MESSAGES ====================
      match /messages/{messageId} {
        // Only owner can access messages
        allow read, write: if isOwner(userId);
      }
      
      // ==================== CONVERSATIONS ====================
      match /conversations/{conversationId} {
        // Only owner can access conversations
        allow read, write: if isOwner(userId);
      }
      
      // ==================== REACTIONS ====================
      match /reactions/{reactionId} {
        // Only owner can access their reactions
        allow read, write: if isOwner(userId);
      }
      
      // ==================== VOICE MESSAGES ====================
      match /voiceMessages/{voiceId} {
        // Only owner can access voice message metadata
        allow read, write: if isOwner(userId);
      }
    }
    
    // ==================== PUBLIC PROFILES (for QR lookup) ====================
    match /publicProfiles/{userId} {
      // Anyone can read public profiles
      allow read: if isAuthenticated();
      
      // Only owner updates their public profile
      allow write: if isOwner(userId);
    }
    
    // ==================== FAMILIES ====================
    match /families/{familyId} {
      // Family members can read
      allow read: if isAuthenticated() 
        && (request.auth.uid in resource.data.memberIds 
            || request.auth.uid == resource.data.adminId);
      
      // Admin can update
      allow update: if isAuthenticated() 
        && request.auth.uid == resource.data.adminId;
      
      // Anyone authenticated can create (becomes admin)
      allow create: if isAuthenticated()
        && request.resource.data.adminId == request.auth.uid;
      
      // Only admin can delete
      allow delete: if isAuthenticated()
        && request.auth.uid == resource.data.adminId;
        
      // Family members subcollection
      match /members/{memberId} {
        allow read, write: if isAuthenticated()
          && (request.auth.uid in get(/databases/$(database)/documents/families/$(familyId)).data.memberIds
              || request.auth.uid == get(/databases/$(database)/documents/families/$(familyId)).data.adminId);
      }
    }
    
    // ==================== EARTHQUAKE DATA ====================
    match /earthquakes/{earthquakeId} {
      // Anyone authenticated can read
      allow read: if isAuthenticated();
      
      // Only server/admin can write (via Cloud Functions)
      allow write: if false;
    }
    
    // ==================== REPORTS ====================
    match /reports/{reportId} {
      // Anyone authenticated can read
      allow read: if isAuthenticated();
      
      // Anyone authenticated can create reports
      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid;
      
      // Only author can update/delete
      allow update, delete: if isOwner(resource.data.userId);
    }
    
    // ==================== SOS ALERTS ====================
    match /sosAlerts/{alertId} {
      // Anyone authenticated can read (emergency info is public)
      allow read: if isAuthenticated();
      
      // Anyone authenticated can create SOS
      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid;
      
      // Only author can update/delete
      allow update, delete: if isOwner(resource.data.userId);
    }
    
    // ==================== ASSEMBLY POINTS ====================
    match /assemblyPoints/{pointId} {
      // Anyone can read
      allow read: if true;
      
      // Only admin (via Cloud Functions)
      allow write: if false;
    }
    
    // ==================== NEWS SUMMARIES ====================
    match /newsSummaries/{summaryId} {
      // Anyone can read
      allow read: if true;
      
      // Anyone authenticated can write (for AI summaries)
      allow write: if isAuthenticated();
    }

    // ==================== DEFAULT DENY ====================
    // Catch-all: deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
