rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isSystemClient() {
      return request.auth != null;
    }

    function allowPublicRead() {
      return isSystemClient() || request.auth == null;
    }

    function allowDeviceWrite(deviceId) {
      return isSystemClient() || (request.resource.data.deviceId == deviceId && request.resource.data.deviceId != null);
    }

    // Devices collection - users can only read/write their own device data
    match /devices/{deviceId} {
      allow read: if allowPublicRead();
      allow write: if allowDeviceWrite(deviceId);

      // Family members subcollection
      match /familyMembers/{memberId} {
        allow read: if allowPublicRead();
        allow write: if allowDeviceWrite(deviceId);
        allow delete: if allowDeviceWrite(deviceId);
      }
      
      // Health profile subcollection
      match /healthProfile/{profileId} {
        allow read: if allowPublicRead();
        allow write: if allowDeviceWrite(deviceId);
        allow delete: if allowDeviceWrite(deviceId);
      }
      
      // ICE (In Case of Emergency) subcollection
      match /ice/{iceId} {
        allow read: if allowPublicRead();
        allow write: if allowDeviceWrite(deviceId);
        allow delete: if allowDeviceWrite(deviceId);
      }
      
      // Location updates subcollection
      match /locationUpdates/{locationId} {
        allow read: if allowPublicRead();
        allow write: if allowDeviceWrite(deviceId);
        allow delete: if allowDeviceWrite(deviceId);
      }
      
      // Status updates subcollection
      match /statusUpdates/{statusId} {
        allow read: if allowPublicRead();
        allow write: if allowDeviceWrite(deviceId);
        allow delete: if allowDeviceWrite(deviceId);
      }
      
      // Earthquake alerts subcollection
      match /earthquakeAlerts/{alertId} {
        allow read: if allowPublicRead();
        allow write: if allowDeviceWrite(deviceId);
        allow delete: if allowDeviceWrite(deviceId);
      }
    }
    
    // Emergency SOS signals collection
    match /sos/{sosId} {
      // Allow anyone to read SOS signals (for emergency response)
      // But only allow write with proper authentication or device ID validation
      allow read: if true;
      allow write: if request.auth != null || request.resource.data.deviceId != null;
      allow delete: if request.auth != null || request.resource.data.deviceId == resource.data.deviceId;
    }
    
    // Messages collection (for BLE mesh backup)
    match /messages/{messageId} {
      // Allow read/write for authenticated users or device ID matching
      allow read: if request.auth != null || resource.data.from == deviceId || resource.data.to == deviceId;
      allow write: if request.auth != null || request.resource.data.from == deviceId;
      allow delete: if request.auth != null || request.resource.data.from == deviceId || request.resource.data.to == deviceId;
    }
    
    // Earthquakes collection (public read for emergency awareness)
    match /earthquakes/{earthquakeId} {
      allow read: if true; // Public read for emergency awareness
      allow write: if request.auth != null || request.resource.data.magnitude >= 4.0; // Only allow critical earthquakes
      allow delete: if request.auth != null; // Only authenticated users can delete
    }

    // News summaries collection
    match /news_summaries/{articleId} {
      allow read: if true; // everyone can read cached summaries
      allow create: if isSystemClient() ||
        (
          !exists(/databases/$(database)/documents/news_summaries/$(articleId)) &&
          request.resource.data.summary is string &&
          request.resource.data.summary.size() <= 6000 &&
          request.resource.data.createdByDeviceId is string &&
          request.resource.data.createdByDeviceId.matches('^afn-[a-zA-Z0-9]{8}$') &&
          request.resource.data.ttlMs is int &&
          request.resource.data.ttlMs > 0 &&
          request.resource.data.ttlMs <= 43200000 // 12 saat
        );
      allow update, delete: if isSystemClient();
    }
    
    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

