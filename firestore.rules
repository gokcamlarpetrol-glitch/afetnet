rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Elite Security: Strict authentication checks
    function isSystemClient() {
      return request.auth != null && request.auth.token.admin == true;
    }

    function isAuthenticated() {
      return request.auth != null;
    }

    // Allow anonymous or authenticated users (always true for emergency features)
    function allowAnonymousOrAuthenticated() {
      return true; // Allow anonymous access for emergency features (location, status, news summaries)
    }

    // Elite: Device ID validation with strict format check
    function isValidDeviceId(deviceId) {
      return deviceId != null && 
             deviceId is string && 
             deviceId.matches('^afn-[a-zA-Z0-9]{8}$') &&
             deviceId.size() == 12;
    }

    // Elite: Validate device ownership with strict checks
    function allowDeviceWrite(deviceId) {
      return isSystemClient() || 
             (isAuthenticated() && 
              isValidDeviceId(deviceId) && 
              request.resource.data.deviceId == deviceId && 
              request.resource.data.deviceId != null &&
              // Prevent deviceId tampering
              resource == null || resource.data.deviceId == deviceId);
    }

    // Elite: Public read only for emergency data (earthquakes, SOS)
    function allowPublicRead() {
      return isSystemClient() || isAuthenticated();
    }

    // Elite: Emergency public read (only for critical data)
    function allowEmergencyPublicRead() {
      return true; // Only for earthquakes and SOS signals
    }

    // Elite Security: Devices collection - STRICT access control
    match /devices/{deviceId} {
      // Elite: Only authenticated users or system can read device data
      allow read: if isAuthenticated() && isValidDeviceId(deviceId);
      // Elite: Only device owner can write, with strict validation
      allow create: if allowDeviceWrite(deviceId) && 
                       isValidDeviceId(request.resource.data.deviceId) &&
                       request.resource.data.deviceId == deviceId;
      allow update: if allowDeviceWrite(deviceId) && 
                       isValidDeviceId(resource.data.deviceId) &&
                       resource.data.deviceId == deviceId &&
                       // Prevent deviceId change
                       request.resource.data.deviceId == resource.data.deviceId;
      allow delete: if isSystemClient();

      // Elite Security: Family members - STRICT validation
      match /familyMembers/{memberId} {
        // Elite: Only device owner can read family members
        allow read: if isAuthenticated() && isValidDeviceId(deviceId);
        allow create: if allowDeviceWrite(deviceId) &&
                         request.resource.data.id is string &&
                         request.resource.data.id.size() > 0 &&
                         request.resource.data.id.size() <= 100 &&
                         request.resource.data.name is string &&
                         request.resource.data.name.size() > 0 &&
                         request.resource.data.name.size() <= 100;
        allow update: if allowDeviceWrite(deviceId) &&
                         request.resource.data.id == resource.data.id; // Prevent ID change
        allow delete: if allowDeviceWrite(deviceId);
      }
      
      // Health profile subcollection
      match /healthProfile/{profileId} {
        allow read: if allowPublicRead();
        allow write: if allowDeviceWrite(deviceId);
        allow delete: if allowDeviceWrite(deviceId);
      }
      
      // ICE (In Case of Emergency) subcollection
      match /ice/{iceId} {
        allow read: if allowPublicRead();
        allow write: if allowDeviceWrite(deviceId);
        allow delete: if allowDeviceWrite(deviceId);
      }
      
      // Location updates subcollection (also check 'locations' for backward compatibility)
      match /locationUpdates/{locationId} {
        allow read: if allowPublicRead();
        allow write: if allowAnonymousOrAuthenticated() && (request.resource.data.deviceId == deviceId || request.resource.data.deviceId == null);
        allow delete: if allowDeviceWrite(deviceId);
      }
      
      match /locations/{locationId} {
        allow read: if allowPublicRead();
        allow write: if allowAnonymousOrAuthenticated() && (request.resource.data.deviceId == deviceId || request.resource.data.deviceId == null);
        allow delete: if allowDeviceWrite(deviceId);
      }
      
      // Status updates subcollection (also check 'status' for backward compatibility)
      match /statusUpdates/{statusId} {
        allow read: if allowPublicRead();
        allow write: if allowAnonymousOrAuthenticated() && (request.resource.data.deviceId == deviceId || request.resource.data.deviceId == null);
        allow delete: if allowDeviceWrite(deviceId);
      }
      
      match /status/{statusId} {
        allow read: if allowPublicRead();
        allow write: if allowAnonymousOrAuthenticated() && (request.resource.data.deviceId == deviceId || request.resource.data.deviceId == null);
        allow delete: if allowDeviceWrite(deviceId);
      }
      
      // Earthquake alerts subcollection
      match /earthquakeAlerts/{alertId} {
        allow read: if allowPublicRead();
        allow write: if allowDeviceWrite(deviceId);
        allow delete: if allowDeviceWrite(deviceId);
      }
    }
    
    // Elite Security: Emergency SOS signals - Public read for emergency, strict write
    match /sos/{sosId} {
      // Elite: Public read for emergency response (life-saving)
      allow read: if allowEmergencyPublicRead();
      // Elite: Strict write validation - only authenticated users or valid device IDs
      allow create: if (isAuthenticated() || 
                        (request.resource.data.deviceId != null && 
                         isValidDeviceId(request.resource.data.deviceId))) &&
                       request.resource.data.deviceId is string &&
                       request.resource.data.timestamp is int &&
                       request.resource.data.latitude is number &&
                       request.resource.data.longitude is number;
      allow update: if isAuthenticated() || 
                       (resource.data.deviceId != null && 
                        request.resource.data.deviceId == resource.data.deviceId);
      allow delete: if isSystemClient() || 
                       (isAuthenticated() && resource.data.deviceId != null);
    }
    
    // Elite Security: Messages collection - STRICT access control
    match /messages/{messageId} {
      // Elite: Only authenticated users or message participants can read
      allow read: if isAuthenticated() && 
                     (resource.data.from is string || resource.data.to is string);
      // Elite: Strict write validation
      allow create: if isAuthenticated() &&
                       request.resource.data.from is string &&
                       isValidDeviceId(request.resource.data.from) &&
                       request.resource.data.to is string &&
                       request.resource.data.content is string &&
                       request.resource.data.content.size() > 0 &&
                       request.resource.data.content.size() <= 10000; // Max message size
      allow update: if false; // Messages are immutable
      allow delete: if isSystemClient() || 
                       (isAuthenticated() && resource.data.from is string);
    }
    
    // Elite Security: Earthquakes collection - Public read for emergency, strict write
    match /earthquakes/{earthquakeId} {
      // Elite: Public read for emergency awareness (life-saving)
      allow read: if allowEmergencyPublicRead();
      // Elite: Strict write validation - only system or authenticated users with magnitude >= 4.0
      allow create: if isSystemClient() || 
                       (isAuthenticated() && 
                        request.resource.data.magnitude is number &&
                        request.resource.data.magnitude >= 4.0 &&
                        request.resource.data.latitude is number &&
                        request.resource.data.longitude is number &&
                        request.resource.data.time is int);
      allow update: if isSystemClient();
      allow delete: if isSystemClient(); // Only system can delete
    }

    // Elite Security: News summaries collection - STRICT validation
    match /news_summaries/{articleId} {
      // Elite: Public read for cached summaries (non-sensitive)
      allow read: if allowEmergencyPublicRead();
      // Elite: Strict create validation - allow anonymous for caching
      allow create: if isSystemClient() ||
        (
          allowAnonymousOrAuthenticated() &&
          !exists(/databases/$(database)/documents/news_summaries/$(articleId)) &&
          request.resource.data.summary is string &&
          request.resource.data.summary.size() > 0 &&
          request.resource.data.summary.size() <= 6000 &&
          (request.resource.data.createdByDeviceId == null || isValidDeviceId(request.resource.data.createdByDeviceId)) &&
          (request.resource.data.ttlMs == null || (request.resource.data.ttlMs is int && request.resource.data.ttlMs > 0 && request.resource.data.ttlMs <= 43200000)) &&
          request.resource.data.articleId is string &&
          request.resource.data.articleId == articleId
        );
      allow update: if isSystemClient() || allowAnonymousOrAuthenticated();
      allow delete: if isSystemClient();
    }
    
    // Backward compatibility: newsSummaries collection
    match /newsSummaries/{articleId} {
      allow read: if allowEmergencyPublicRead();
      allow create: if isSystemClient() || allowAnonymousOrAuthenticated();
      allow update: if isSystemClient() || allowAnonymousOrAuthenticated();
      allow delete: if isSystemClient();
    }
    
    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

