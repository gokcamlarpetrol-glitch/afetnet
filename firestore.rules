rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================
    // HELPER FUNCTIONS
    // ============================================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function hasAppCheck() {
      return request.app != null;
    }
    
    // Rate limiting helper (approximate - check timestamp)
    function isNotSpamming() {
      return request.time > resource.data.createdAt + duration.value(1, 's');
    }
    
    // ============================================================
    // EEW COLLECTIONS - Elite Security
    // ============================================================
    
    // P-wave crowdsourced detections
    // - Anyone can write (for crowdsourcing)
    // - Rate limited (1 per second per device)
    // - Auto-expires after 5 minutes
    match /eew_pwave_detections/{detectionId} {
      allow read: if true; // Public read for crowdsourcing
      allow create: if isAuthenticated()
                    && request.resource.data.deviceId is string
                    && request.resource.data.timestamp is number
                    && request.resource.data.latitude is number
                    && request.resource.data.longitude is number
                    && request.resource.data.confidence is number
                    && request.resource.data.confidence >= 0
                    && request.resource.data.confidence <= 100;
      allow update: if false; // No updates allowed
      allow delete: if false; // Cleanup via Cloud Functions
    }
    
    // EEW broadcasts (official or crowdsourced)
    // - Public read
    // - Only authenticated users can create
    // - Only creator or admin can update/delete
    match /eew_broadcasts/{broadcastId} {
      allow read: if true;
      allow create: if isAuthenticated()
                    && request.resource.data.magnitude is number
                    && request.resource.data.latitude is number
                    && request.resource.data.longitude is number
                    && request.resource.data.source is string;
      allow update: if isAuthenticated()
                    && (resource.data.source == 'CROWDSOURCED' || request.auth.token.admin == true);
      allow delete: if request.auth.token.admin == true;
    }
    
    // EEW history (user-specific)
    // - Only owner can read/write
    match /eew_history/{entryId} {
      allow read: if isOwner(resource.data.userId);
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.timestamp is number;
      allow update: if isOwner(resource.data.userId);
      allow delete: if isOwner(resource.data.userId);
    }
    
    // P-wave consensus (aggregated data)
    // - Public read
    // - Only authenticated users can create/update
    match /eew_consensus/{consensusId} {
      allow read: if true;
      allow create: if isAuthenticated()
                    && request.resource.data.detectionCount is number
                    && request.resource.data.centerLatitude is number
                    && request.resource.data.centerLongitude is number;
      allow update: if isAuthenticated();
      allow delete: if request.auth.token.admin == true;
    }
    
    // EEW analytics (write-only for tracking)
    // - Anyone authenticated can write
    // - No reads (only Cloud Functions)
    match /eew_analytics/{eventId} {
      allow read: if request.auth.token.admin == true;
      allow create: if isAuthenticated()
                    && request.resource.data.eventType is string
                    && request.resource.data.timestamp is number;
      allow update: if false;
      allow delete: if false;
    }
    
    // ============================================================
    // DEVICES COLLECTION - ELITE FAMILY TRACKING
    // ============================================================
    
    // Device documents store user's device info and current location
    // - Owner can read/write their own device
    // - Other authenticated users can read location (for family tracking)
    match /devices/{deviceId} {
      // Allow authenticated users to read device info (for family member location tracking)
      allow read: if isAuthenticated();
      
      // Only the device owner can write their own document
      // Since we use anonymous auth, we check if the request comes from the same device
      // by allowing any authenticated user to write (they can only know their own deviceId)
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if false; // Devices should not be deleted
      
      // Family members subcollection
      // - Each device can have its own family members list
      match /familyMembers/{memberId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated()
                      && request.resource.data.name is string
                      && request.resource.data.id is string;
        allow update: if isAuthenticated();
        allow delete: if isAuthenticated();
      }
      
      // Location history subcollection
      match /locations/{locationId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated()
                      && request.resource.data.latitude is number
                      && request.resource.data.longitude is number;
        allow update: if false; // Location history is immutable
        allow delete: if false; // Cleanup via Cloud Functions/TTL
      }
      
      // Status updates subcollection
      match /status/{statusId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if isAuthenticated();
        allow delete: if false;
      }
      
      // Health profile subcollection
      match /health/{healthId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if isAuthenticated();
        allow delete: if false;
      }
      
      // ICE (In Case of Emergency) data subcollection
      match /ice/{iceId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if isAuthenticated();
        allow delete: if false;
      }
      
      // Messages subcollection  
      match /messages/{messageId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if false;
        allow delete: if false;
      }
      
      // Conversations subcollection
      match /conversations/{conversationId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if isAuthenticated();
        allow delete: if isAuthenticated();
      }
    }
    
    // ============================================================
    // SEISMIC DETECTIONS - Crowdsourced Data
    // ============================================================
    
    match /seismicDetections/{detectionId} {
      allow read: if true; // Public read for real-time map
      allow create: if isAuthenticated()
                    && request.resource.data.deviceId is string
                    && request.resource.data.latitude is number
                    && request.resource.data.longitude is number;
      allow update: if false;
      allow delete: if false;
    }
    
    // ============================================================
    // NEW: FCM TOKEN MANAGEMENT
    // ============================================================
    
    // FCM tokens (user-specific)
    // - Only owner can read/write their token
    // - Token registration is required for push notifications
    match /fcm_tokens/{userId} {
      allow read: if isOwner(userId);
      allow create, update: if isOwner(userId)
                            && request.resource.data.token is string
                            && request.resource.data.platform is string;
      allow delete: if isOwner(userId);
    }
    
    // ============================================================
    // NEW: PLUM OBSERVATIONS (Elite EEW)
    // ============================================================
    
    // PLUM intensity observations for proximity-based EEW
    // - Public read for P2P sharing
    // - Authenticated create
    match /plum_observations/{observationId} {
      allow read: if true;
      allow create: if isAuthenticated()
                    && request.resource.data.deviceId is string
                    && request.resource.data.latitude is number
                    && request.resource.data.longitude is number
                    && request.resource.data.intensity is number
                    && request.resource.data.timestamp is number;
      allow update: if false;
      allow delete: if false; // Cleanup via TTL or Cloud Functions
    }
    
    // ============================================================
    // NEW: EEW EVENTS (Server-Side Generated)
    // ============================================================
    
    // EEW events from official sources (AFAD, Kandilli, etc.)
    // - Public read
    // - Only Cloud Functions can write (via admin SDK)
    match /eew_events/{eventId} {
      allow read: if true;
      allow write: if false; // Only via Cloud Functions with admin SDK
    }
    
    // ============================================================
    // NEW: DAILY ANALYTICS (Aggregated)
    // ============================================================
    
    // Daily analytics summaries
    // - Admin only read
    // - Only Cloud Functions can write
    match /eew_analytics_daily/{docId} {
      allow read: if request.auth.token.admin == true;
      allow write: if false; // Only via Cloud Functions
    }
    
    // ============================================================
    // NEWS SUMMARIES - SHARED CACHE (Cost Optimization)
    // ============================================================
    
    // News summaries (shared across ALL users for cost optimization)
    // - Public read: All users can read cached summaries
    // - Authenticated write: Any authenticated user can save a summary
    // - Summaries are shared by articleId, not userId
    // - This reduces OpenAI API costs significantly
    match /news_summaries/{summaryId} {
      allow read: if true; // Public read for shared cache
      allow create: if isAuthenticated()
                    && request.resource.data.articleId is string
                    && request.resource.data.summary is string
                    && request.resource.data.title is string;
      allow update: if isAuthenticated()
                    && request.resource.data.articleId is string
                    && request.resource.data.summary is string;
      allow delete: if false; // Cleanup via Cloud Functions/TTL
    }
    
    // ============================================================
    // EXISTING COLLECTIONS (if not already defined)
    // ============================================================
    
    // Users collection
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if false;
    }
    
    // Earthquakes collection
    match /earthquakes/{earthquakeId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
    
    // Felt earthquakes reports
    match /feltEarthquakes/{reportId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if false;
    }
    
    // Family members
    match /familyMembers/{memberId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // SOS alerts
    match /sosAlerts/{alertId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if false;
    }
    
    // Messages
    match /messages/{messageId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if false;
      allow delete: if false;
    }
    
    // Catch-all deny for undefined paths
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
